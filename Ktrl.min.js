(function(){if("undefined"===typeof navigator.requestMIDIAccess)throw Error("[Ktrl] your browser does not support Web MIDI API. Halt.");})();
Ktrl=function(){function g(a){this.input=a;this.targets=[];var b=this;this.input.onmidimessage=function(a){for(var d=b.targets.length;d--;)b.targets[d].ondata(a)}}function h(a){this.id=k++;this.label=a||"Untitled";this.active=!1;this.process=function(){};var b=this;this.ondata=function(a){b.active&&b.process(a)};f.push(this)}function d(a){console.log("[ktrl] "+a)}var e=[],f=[],k=0,j=null;g.prototype={constructor:g,removeTarget:function(a){var b=this;this.targets.map(function(c){c===a&&(c=b.targets.indexOf(a),
b.targets.splice(c,1))})},addTarget:function(a){for(var b=0;b<this.targets.length;++b)if(this.targets[b]===a){d("duplicate target.");return}this.targets.push(a)}};h.prototype={constructor:h,onData:function(a){this.process=a},activate:function(){this.active=!0},disable:function(){this.active=!1},getID:function(){return this.id}};parse=function(a){a=a.data;var b=(a[0]&15)+1,c;switch(a[0]>>4){case 8:c={type:"noteoff",channel:b,pitch:a[1],velocity:a[2]};break;case 9:c={type:"noteon",channel:b,pitch:a[1],
velocity:a[2]};break;case 10:c={type:"polypressure",channel:b,pitch:a[1],pressure:a[2]};break;case 11:c={type:"controlchange",channel:b,control:a[1],value:a[2]};break;case 12:c={type:"programchange",channel:b,program:a[1]};break;case 13:c={type:"channelpressure",channel:b,pressure:a[1]};break;case 14:c={type:"pitchwheel",channel:b,wheel:a[1]<<8|a[2]}}return c};navigator.requestMIDIAccess().then(function(a){if(0===a.inputs().length)d("no input ports available");else{for(var b=0;b<a.inputs().length;++b)e[b]=
new g(a.inputs()[b]);d("Ktrl (r1) is ready.");"function"===typeof j?j():d("onReady is not specified.")}},function(a){d("failed to get MIDI access: "+a)});return{createTarget:function(a){return new h(a)},removeTarget:function(a){return Ktrl.disconnectTarget(a)?(f.map(function(b){b===a&&(b=f.indexOf(a),f.splice(b,1))}),!0):!1},disconnectTarget:function(a){e.map(function(b){b.removeTarget(a)});return!0},routeAllToTarget:function(a){e.map(function(b){b.addTarget(a)});return!0},routeSourceToTarget:function(a,
b){if(a<e.length)return e.map(function(a){a.removeTarget(b)}),e[a].addTarget(b),!0;d("invalid source id or target.");return!1},ready:function(a){"function"!==typeof a?d("invalid handler function."):j=a},parse:parse,report:function(){var a=0;d("listing available MIDI Input Ports...");e.map(function(b){console.log(b.input.type,a++,"\t",b.input.name,"\t",b.input.manufacturer)});d("listing available MIDI targets...");f.map(function(a){console.log("id "+a.id,"\t",a.label,"\t",a.active)})}}}();
